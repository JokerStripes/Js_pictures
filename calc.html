<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>PK Visual — Educational (Classroom)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#fbfdff;color:#111;margin:18px}
  .card{background:#fff;padding:14px;border-radius:8px;box-shadow:0 2px 10px rgba(30,60,90,0.06);margin-bottom:14px}
  label{font-weight:600;display:block;margin-bottom:6px}
  input[type=number]{padding:8px;border-radius:6px;border:1px solid #dfeeff;width:120px}
  button{padding:8px 12px;background:#2b7cff;color:#fff;border:none;border-radius:6px;cursor:pointer}
  .controls{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  canvas{width:100%;height:360px}
  .note{font-size:0.9rem;color:#555;margin-top:8px}
</style>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <h2>PK Visual — Educational (Classroom)</h2>

  <div class="card">
    <strong>Purpose:</strong> visual classroom tool to illustrate parent→metabolite kinetics. Students estimate crossing points visually; the page does not compute detection times. <br>
    <small class="note">Fixed model: parent t½=1.5 h, metabolite fraction=0.40, metabolite t½=12 h, distribution volume=5 L.</small>
  </div>

  <div class="card">
    <div class="controls">
      <div>
        <label for="doseIn">Amount taken (g)</label>
        <input id="doseIn" type="number" min="0" step="0.01" value="1.00">
      </div>

      <div>
        <label for="showRef">Show reference line (threshold)</label>
        <input id="showRef" type="checkbox">
      </div>

      <div>
        <label for="refVal">Reference value (μg/L) — for teacher to set</label>
        <input id="refVal" type="number" min="0" step="1" value="50">
      </div>

      <div style="align-self:flex-end">
        <button id="renderBtn">Render graph</button>
      </div>
    </div>

    <div class="note">Instructions for instructors: set a reference line (e.g., a cutoff) and ask students to estimate the hour where the metabolite curve visually crosses it. The chart intentionally does not compute that time numerically.</div>
  </div>

  <div class="card">
    <canvas id="chartCanvas"></canvas>
  </div>

<script>
(function(){
  // Fixed educational parameters
  const t12_parent = 1.5;
  const t12_met = 12.0;
  const frac = 0.40;
  const vol = 5.0; // L
  const tmax = 200;
  const npoints = 600;

  function ln2(){ return Math.log(2); }
  const kp = ln2() / t12_parent;
  const km = ln2() / t12_met;

  function computeCurves(dose_g){
    const A0 = dose_g * 1e6; // ug
    const times = new Array(npoints+1);
    const parent = new Array(npoints+1);
    const met = new Array(npoints+1);
    for(let i=0;i<=npoints;i++){
      const t = (i/npoints)*tmax;
      times[i] = t;
      const Ap = A0 * Math.exp(-kp * t);
      parent[i] = Ap / vol;
      let M = 0;
      if (Math.abs(km - kp) > 1e-12) {
        M = frac * A0 * (kp/(km - kp)) * (Math.exp(-kp*t) - Math.exp(-km*t));
      } else {
        M = frac * A0 * kp * t * Math.exp(-kp*t);
      }
      met[i] = M / vol;
    }
    return {times, parent, met};
  }

  // Create chart
  const ctx = document.getElementById('chartCanvas').getContext('2d');
  const config = {
    type:'line',
    data: { labels: [], datasets:[
      {label:'Parent (μg/L)', data:[], borderColor:'#2b7cff', pointRadius:0, tension:0.12},
      {label:'Metabolite (μg/L)', data:[], borderColor:'#d44', pointRadius:0, tension:0.12, borderDash:[6,4]}
    ]},
    options:{
      responsive:true,
      maintainAspectRatio:false,
      scales:{
        x:{ title:{display:true, text:'Time (hours)'} },
        y:{ title:{display:true, text:'Concentration (μg/L)'}, beginAtZero:true, type:'linear' }
      },
      plugins:{
        legend:{position:'top'},
        tooltip:{callbacks:{label:function(ctx){
          return ctx.dataset.label + ': ' + Number(ctx.parsed.y).toExponential(3) + ' μg/L';
        }}}
      }
    }
  };
  const chart = new Chart(ctx, config);

  const doseIn = document.getElementById('doseIn');
  const showRef = document.getElementById('showRef');
  const refVal = document.getElementById('refVal');
  const renderBtn = document.getElementById('renderBtn');

  function render(){
    const dose = parseFloat(doseIn.value) || 0;
    const data = computeCurves(dose);
    chart.data.labels = data.times.map(t=>t.toFixed(1));
    chart.data.datasets[0].data = data.parent;
    chart.data.datasets[1].data = data.met;

    // toggle reference line plugin: we draw a horizontal annotation by adding a dataset that is not in legend
    const show = showRef.checked;
    const ref = parseFloat(refVal.value) || 0;

    // remove any previous ref dataset
    chart.data.datasets = chart.data.datasets.filter(ds => !ds._isRefLine);

    if (show && ref >= 0) {
      // build array same length as labels with constant value ref
      const refArray = new Array(data.times.length).fill(ref);
      chart.data.datasets.push({
        label: 'Reference line (teacher set)',
        data: refArray,
        borderColor: '#222',
        borderWidth: 1,
        pointRadius: 0,
        borderDash: [4,4],
        fill: false,
        _isRefLine: true,
        // hide in legend so students don't treat it as a curve; show label in tooltip only if needed
        hidden: false
      });
    }

    // update y-scale to fit data nicely
    const allVals = data.parent.concat(data.met);
    const maxV = Math.max(...allVals, show ? ref : 0);
    chart.options.scales.y.max = Math.ceil(maxV * 1.1);
    chart.update();
  }

  renderBtn.addEventListener('click', render);

  // initial render
  render();

})();
</script>
</body>
</html>